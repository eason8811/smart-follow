# 1. 外部抓取 (Crawl 领域)

- `CrawlTaskAggregate` 爬取任务聚合
    - 在同一时间窗口内, 针对同一交易所, 同一 API, 同一规范化参数, 仅创建并执行一次任务
    - 可以记录任务的完成进度, 以便中断恢复
    - 提供锁与过期 TTL, 避免单次执行时间过长导致的重入
- `CrawlLogEntity` 爬取任务的日志实体, 每一条都是**不可变事实**
    - 用于记录一个爬取任务内的一次爬取操作的 **输入, 结果, 状态, 耗时** 等信息
    - 使用 `success` 和 `failure` 方法进行爬取操作日志的受控创建

## crawl_log（抓取操作日志事实表）

**表备注**：采集日志（不可变事实），支持 304/短路，便于审计与统计

### 字段

| 列名                  | 数据类型                  | 约束                           | 字段注解                    |
|---------------------|-----------------------|------------------------------|-------------------------|
| id                  | BIGINT                | NOT NULL, AUTO_INCREMENT, PK | 主键ID                    |
| task_id             | VARCHAR(191)          | NOT NULL                     | 所属任务ID/自然键串             |
| exchange            | ENUM('OKX','BINANCE') | NOT NULL                     | 交易所                     |
| target              | VARCHAR(512)          | NOT NULL                     | 规范化抓取目标（URL/资源标识）       |
| method              | VARCHAR(16)           | NOT NULL                     | HTTP 方法（GET/POST/...）   |
| request_params_json | JSON                  | NULL                         | 规范化参数 JSON              |
| params_hash         | CHAR(64)              | NOT NULL                     | 参数哈希（SHA-256 等）         |
| started_at          | TIMESTAMP(3)          | NOT NULL                     | 开始时间（UTC）               |
| finished_at         | TIMESTAMP(3)          | NOT NULL                     | 结束时间（UTC）               |
| status_code         | INT                   | NULL                         | HTTP 状态码（失败也记录）         |
| success             | BOOLEAN               | NOT NULL                     | 是否成功（2xx 或 304）         |
| not_modified        | BOOLEAN               | NOT NULL, DEFAULT FALSE      | 是否 304/短路               |
| content_length      | BIGINT                | NULL                         | 响应字节数                   |
| etag                | VARCHAR(255)          | NULL                         | 响应 ETag                 |
| last_modified_raw   | VARCHAR(255)          | NULL                         | Last-Modified 原始值       |
| last_modified_at    | TIMESTAMP(3)          | NULL                         | 解析后的 Last-Modified（UTC） |
| content_hash        | CHAR(64)              | NULL                         | 内容哈希（SHA-256 等）         |
| error_msg           | TEXT                  | NULL                         | 错误信息                    |

### 索引与作用

| 索引名                      | 类型    | 列                                        | 唯一性 | 作用说明                       |
|--------------------------|-------|------------------------------------------|-----|----------------------------|
| PRIMARY                  | BTREE | id                                       | 是   | 主键定位。                      |
| idx_task_time            | BTREE | (task_id, started_at DESC)               | 否   | 同一任务按时间倒序检索/分页（查看最近抓取）。    |
| idx_exchange_target_time | BTREE | (exchange, target, started_at DESC)      | 否   | 按交易所+目标的时间序列查询与统计（近况、失败率）。 |
| idx_target_notmod        | BTREE | (exchange, target, not_modified)         | 否   | 快速筛出 304/短路命中情况，评估缓存效果。    |
| idx_params_time          | BTREE | (exchange, params_hash, started_at DESC) | 否   | 按规范化参数去重/回查同参请求的历史表现与内容变更。 |

### 备注

* **去重/缓存命中**：优先利用 `ETag` 与 `Last-Modified`（服务器侧条件请求）；客户端侧可用 `content_hash` 对比同
  `params_hash` 的响应体变化，`not_modified=TRUE` 标记 304。
* **JSON 参数**：`request_params_json` 仅做记录，不参与索引；配套 `params_hash` 支持等价参数的去重与命中统计。
* **DESC 索引**：`started_at DESC` 便于近端倒序查询（MySQL 8.0+ 有效）；若需向后兼容旧版本，可在查询中
  `ORDER BY started_at DESC` 并保留复合索引的前缀顺序以获得优化器利用。

## crawl_task（抓取任务表）

**表备注**：

- 爬取任务聚合，意图级去重, 在同一时间窗口内, 针对同一交易所, 同一 API, 同一规范化参数, 仅创建并执行一次任务 (基于
  exchange+apiName+paramsHash+windowKey 唯一键)
- 可重入锁
- 任务状态机
- 分页爬取进度保存

### 字段

| 列名           | 数据类型                                                            | 约束                                                                                                                              | 字段注解                        |
|--------------|-----------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------|-----------------------------|
| id           | BIGINT                                                          | NOT NULL, AUTO_INCREMENT, PK                                                                                                    | 主键ID                        |
| exchange     | ENUM('OKX','BINANCE')                                           | NOT NULL                                                                                                                        | 目标交易所                       |
| api_name     | VARCHAR(96)                                                     | NOT NULL                                                                                                                        | API 名称                      |
| params_hash  | CHAR(64)                                                        | NOT NULL                                                                                                                        | 规范化参数哈希（SHA-256 等）          |
| params_json  | TEXT                                                            | NULL                                                                                                                            | 规范化参数 JSON（TEXT 以兼容驱动/ORM）  |
| window_key   | VARCHAR(128)                                                    | NOT NULL                                                                                                                        | 时间窗口键                       |
| total_page   | INT                                                             | NULL                                                                                                                            | 总页数（NULL 表示未知）              |
| next_page    | INT                                                             | NOT NULL, DEFAULT 1                                                                                                             | 下一页（1-based）                |
| status       | ENUM('PENDING','RUNNING','DONE','FAILED','EXPIRED','CANCELLED') | NOT NULL, DEFAULT 'PENDING'                                                                                                     | 任务状态                        |
| attempts     | INT                                                             | NOT NULL, DEFAULT 0                                                                                                             | 错误累计次数                      |
| last_error   | TEXT                                                            | NULL                                                                                                                            | 最后一次错误信息                    |
| locked_by    | VARCHAR(191)                                                    | NULL                                                                                                                            | 当前锁持有者                      |
| locked_at    | TIMESTAMP(3)                                                    | NULL                                                                                                                            | 加锁时间（UTC）                   |
| lock_ttl_sec | INT                                                             | NULL                                                                                                                            | 锁 TTL（秒）                    |
| locked_until | TIMESTAMP(3)                                                    | GENERATED ALWAYS AS `IF(locked_at IS NULL OR lock_ttl_sec IS NULL, NULL, TIMESTAMPADD(SECOND, lock_ttl_sec, locked_at))` STORED | 生成列：锁过期时间 = locked_at + ttl |
| created_at   | TIMESTAMP(3)                                                    | NOT NULL, DEFAULT CURRENT_TIMESTAMP(3)                                                                                          | 创建时间                        |
| updated_at   | TIMESTAMP(3)                                                    | NOT NULL, DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3)                                                           | 更新时间                        |

### 索引与作用

| 索引名                     | 类型    | 列                                             | 唯一性 | 作用说明                                                   |
|-------------------------|-------|-----------------------------------------------|-----|--------------------------------------------------------|
| PRIMARY                 | BTREE | id                                            | 是   | 主键定位。                                                  |
| uk_task_intent          | BTREE | (exchange, api_name, params_hash, window_key) | 是   | **意图级幂等**：同交易所+API+参数+时间窗口仅创建一次任务，避免重入。                |
| idx_status_lockeduntil  | BTREE | (status, locked_until)                        | 否   | 调度扫描可抢占任务：按状态过滤后对 `locked_until` 进行“已过期/未加锁”判断，减少全表扫描。 |
| idx_exchange_api_status | BTREE | (exchange, api_name, status)                  | 否   | 按交易所与 API 维度统计/看板/批量操作（如重试、取消）。                        |

### 备注

* **校验（CHECK）**:
  ```mysql
    /* 健壮性检查 (MySQL 8.0.16+才强制执行; 旧版仅作为文档) */
    CHECK (`next_page` >= 1),
    CHECK (`total_page` IS NULL OR `total_page` >= 0),
    CHECK (`lock_ttl_sec` IS NULL OR `lock_ttl_sec` > 0)```
* **调度建议**：抢任务常用条件示例：`status IN ('PENDING','RUNNING') AND (locked_until IS NULL OR locked_until <= NOW(3))`
  ，先用 `idx_status_lockeduntil` 缩小集合，再进行乐观加锁更新。

# 2. 项目目录/主档 (Project 领域)

- `ProjectAggregate` 项目主档聚合, 记录项目的基本信息, 对系统内的项目进行受控创建
- `ProjectBriefVO` 项目简单快照, 将一些 API 返回的基本信息进行映射, 也用于 **创建新的项目主档**
- `ProjectKey` 系统内项目唯一标识, 由 **交易所名称** 和 **外部 ID** 组成 `(Exchange:ExternalId)`
- `LeadTradersQuery` 获取交易员排名的请求参数结构
- `LeadTradersPageVO` 交易员榜单分页数据响应, 用于把 API 返回数据映射成对象

## exchange_project（项目主表）

**表备注**: 项目主档，供快照/交易/墓碑等表引用（逻辑外键）

### 字段

| 列名                 | 数据类型                               | 约束                           | 字段注解                               |
|--------------------|------------------------------------|------------------------------|------------------------------------|
| id                 | BIGINT                             | NOT NULL, AUTO_INCREMENT, PK | 主键ID                               |
| exchange           | ENUM('OKX','BINANCE')              | NOT NULL                     | 交易所标识（OKX/BINANCE）                 |
| leader_external_id | VARCHAR(191)                       | NOT NULL                     | 平台侧项目/领航员稳定外部ID（逻辑唯一）              |
| name               | VARCHAR(255)                       | NULL                         | 项目/领航员名称                           |
| status             | VARCHAR(64)                        | NULL                         | 运行状态（如 RUNNING/CLOSED/PAUSED 等，文本） |
| first_seen         | TIMESTAMP(3)                       | NOT NULL                     | 首次被系统发现时间                          |
| last_seen          | TIMESTAMP(3)                       | NOT NULL                     | 最近一次被看到时间                          |
| last_visibility    | ENUM('VISIBLE','MISSING','HIDDEN') | NOT NULL, DEFAULT 'VISIBLE'  | 最近可见性                              |
| min_copy_cost      | DECIMAL(36,18)                     | NULL                         | 最小可复制保证金/成本（USDT口径）                |
| base_currency      | VARCHAR(16)                        | NULL, DEFAULT 'USDT'         | 计价币（默认 USDT）                       |
| data_quality_score | FLOAT                              | NULL, DEFAULT 1.0            | 数据质量分（0~1）                         |
| extra              | JSON                               | NOT NULL                     | 平台特有原始字段（JSON）                     |

### 索引与作用

| 索引名                | 类型    | 列                              | 唯一性 | 作用说明                               |
|--------------------|-------|--------------------------------|-----|------------------------------------|
| PRIMARY            | BTREE | id                             | 是   | 主键定位单条记录，联表/更新/删除的首选键。             |
| uk_exchange_leader | BTREE | (exchange, leader_external_id) | 是   | 保证同一交易所下外部ID唯一；按交易所+外部ID快速精确查找/去重。 |
| idx_exchange       | BTREE | exchange                       | 否   | 支持按交易所的常见筛选、统计与分区式访问（例如分页列表、聚合）。   |

### 备注:

* `leader_external_id` 取 191 长度可兼容旧版 MySQL 的索引长度限制（utf8mb4 下单列索引字节数控制），同时满足唯一约束建立的需要。

# 3. 项目快照 + 可见性变化事件 + 墓碑 (Observation 领域)

- `ProjectSnapshotAggregate` 项目时序快照聚合, 按照时间顺序记录项目在某个时间点的详细信息
    - 如带单权益, 跟单人数, 胜率, PNL, ROI 等
    - 与 `ProjectAggregate` 项目主档聚合的区别在于, 项目主档聚合记录的主要是与 **标的或盈利能力无关的信息**,
      而项目时序快照聚合记录的内容还包括了 **项目盈利能力有关的信息**
- `TombstoneAggregate` 墓碑聚合
    - 用于记录项目生命周期中, 从何时开始项目变为不可见, 何时从不可见状态离开
    - 导致不可见的原因是什么
    - 是哪个行为 (项目详情信息获取不到, 观察到本次详情页确实缺失这个项目等) 发现了这个项目的缺失
- `VisibilityChangeVO` 可见性变化事件, 用于记录项目从哪个状态变化到哪个状态, 发生的时间, 以及原因
- `SnapshotPointVO` 时序点, 用于曲线渲染或构造查询结果 (现暂做冗余)

## exchange_project_snapshot（项目时序快照表）

**表备注**：每次采集的项目时序快照（按来源区分），用于画像/排序与可见性监测
**分区策略**：按 `ts` 做 RANGE 分区（按月）；已有 `p2025_08`、`p2025_09`、`p2025_10`，以及兜底 `pMAX`

### 字段

| 列名             | 数据类型                               | 约束                                                                                                  | 字段注解                                          |
|----------------|------------------------------------|-----------------------------------------------------------------------------------------------------|-----------------------------------------------|
| id             | BIGINT                             | NOT NULL, AUTO_INCREMENT, PK                                                                        | 主键ID                                          |
| project_id     | BIGINT                             | NOT NULL                                                                                            | 逻辑外键，指向 `exchange_project.id`                 |
| ts             | TIMESTAMP(3)                       | NOT NULL                                                                                            | 快照时间（分区键）                                     |
| data_ver       | CHAR(14)                           | NULL                                                                                                | 来源数据版本号，如 `20231129213200`                    |
| source         | VARCHAR(32)                        | NOT NULL, DEFAULT 'OKX_RANK'                                                                        | 快照来源：`OKX_RANK` / `OKX_DETAIL` / `COMPUTED` 等 |
| visibility     | ENUM('VISIBLE','MISSING','HIDDEN') | NOT NULL                                                                                            | 可见性                                           |
| equity         | DECIMAL(36,18)                     | NULL                                                                                                | 权益/AUM（USDT口径，部分来源缺失）                         |
| followers      | INT                                | NULL                                                                                                | 跟随人数（如 OKX ranks[].copyTraderNum）             |
| positions_open | INT                                | NULL                                                                                                | 持仓笔数（仅含持仓信息的来源有效）                             |
| fees_daily     | DECIMAL(36,18)                     | NULL                                                                                                | 当日费用（含费用信息的来源有效）                              |
| pnl_daily      | DECIMAL(36,18)                     | NULL                                                                                                | 当日 PnL（含收益信息的来源有效）                            |
| raw            | JSON                               | NOT NULL                                                                                            | 原始快照 JSON；按 `source` 存放对应来源原文                 |
| aum_usd        | DECIMAL(36,18)                     | GENERATED ALWAYS AS (CAST(JSON_UNQUOTE(JSON_EXTRACT(`raw`, '$.aum')) AS DECIMAL(36,18))) STORED     | 生成列：`raw.$.aum` → AUM(USDT)，便于筛选/排序           |
| win_ratio      | DECIMAL(18,6)                      | GENERATED ALWAYS AS (CAST(JSON_UNQUOTE(JSON_EXTRACT(`raw`, '$.winRatio')) AS DECIMAL(18,6))) STORED | 生成列：`raw.$.winRatio` → 胜率（0.1=10%）            |
| pnl_ratio_90d  | DECIMAL(18,6)                      | GENERATED ALWAYS AS (CAST(JSON_UNQUOTE(JSON_EXTRACT(`raw`, '$.pnlRatio')) AS DECIMAL(18,6))) STORED | 生成列：`raw.$.pnlRatio` → 近90日收益率                |
| pnl_90d_usd    | DECIMAL(36,18)                     | GENERATED ALWAYS AS (CAST(JSON_UNQUOTE(JSON_EXTRACT(`raw`, '$.pnl')) AS DECIMAL(36,18))) STORED     | 生成列：`raw.$.pnl` → 近90日收益（USDT）                |

### 索引与作用

| 索引名                    | 类型    | 列                        | 唯一性 | 作用说明                                               |
|------------------------|-------|--------------------------|-----|----------------------------------------------------|
| PRIMARY                | BTREE | id                       | 是   | 主键定位单条记录。                                          |
| uk_proj_ts_src         | BTREE | (project_id, ts, source) | 是   | 幂等唯一：同一项目 + 同一时间点 + 同一来源仅一条快照；保障去重与覆盖写入。           |
| idx_proj_ts            | BTREE | (project_id, ts)         | 否   | 支持按项目的时间范围检索与最新快照查询（如 `ORDER BY ts DESC LIMIT 1`）。 |
| idx_snapshot_aum       | BTREE | aum_usd                  | 否   | 基于生成列的 AUM 排序/筛选（排行榜/过滤）。                          |
| idx_snapshot_win_ratio | BTREE | win_ratio                | 否   | 胜率过滤/排序。                                           |
| idx_snapshot_pnl_ratio | BTREE | pnl_ratio_90d            | 否   | 近90日收益率过滤/排序。                                      |

### 备注

* 生成列使用 **STORED** 以支持建索引与稳定排序；当 `raw` 缺字段或不可解析时，对应生成列为 `NULL`（可与 `IS NULL` 配合排除）。
* 分区维护：`pMAX` 作为兜底；月初可对 `pMAX` 执行 `REORGANIZE PARTITION` 切出新月份分区，保持写入热分区有序。

## tombstone（墓碑表）

**表备注**：记录项目可见性由 `VISIBLE` → `MISSING/HIDDEN` 的事件（“幸存者偏差黑匣子”）

### 字段

| 列名               | 数据类型         | 约束                                                                    | 字段注解                                           |
|------------------|--------------|-----------------------------------------------------------------------|------------------------------------------------|
| project_id       | BIGINT       | NOT NULL                                                              | 逻辑外键，指向 `exchange_project.id`                  |
| fromTs           | TIMESTAMP(3) | NOT NULL                                                              | 第一次从可见转为缺失/隐藏的时间（事件起点）                         |
| toTs             | TIMESTAMP(3) | NULL                                                                  | 不可见状态结束时间；为空表示仍处于不可见                           |
| last_snapshot_id | BIGINT       | NULL                                                                  | 消失前最后一次快照ID（指向 `exchange_project_snapshot.id`） |
| reason_code      | VARCHAR(16)  | NULL                                                                  | 原因代码（如下架/清退/改名等）                               |
| reason_msg       | VARCHAR(255) | NULL                                                                  | 原因信息（文本说明）                                     |
| detector         | VARCHAR(128) | NULL                                                                  | 触发来源（检测器/任务名等）                                 |
| created_at       | TIMESTAMP(3) | NOT NULL, DEFAULT CURRENT_TIMESTAMP(3)                                | 创建时间                                           |
| updated_at       | TIMESTAMP(3) | NOT NULL, DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3) | 更新时间                                           |

### 索引与作用

| 索引名           | 类型    | 列                    | 唯一性 | 作用说明                                                                             |
|---------------|-------|----------------------|-----|----------------------------------------------------------------------------------|
| PRIMARY       | BTREE | (project_id, fromTs) | 是   | 保证同一项目在同一“起始时刻”的事件仅一条；支持项目维度按时间排序/区间检索（如查最近一次消失：`ORDER BY fromTs DESC LIMIT 1`）。 |
| idx_last_snap | BTREE | last_snapshot_id     | 否   | 通过“最后快照ID”快速回溯到对应快照做审计/取证、补全消失前画像。                                               |

### 备注

* 进行“仍在不可见”筛选时可用 `toTs IS NULL`。如该查询较频繁，可考虑新增 `(project_id, toTs)` 或 `(toTs)` 辅助索引以优化活跃墓碑扫描。
* 事件天然是区间 `[fromTs, toTs)`；统计横截面（某时刻处于不可见的项目）时，条件通常为
  `fromTs <= :asOf AND (toTs IS NULL OR toTs > :asOf)`。

# 4. 仓位回合 (Trade 领域)

- `ProjectTradeAggregate` 单个仓位回合聚合根, 用于记录一对开平仓操作的完整信息, 提供基于 `Builder` 的受控创建方法
    - 使用先进先出策略, 配对开平仓操作, 一个开平仓操作作为一个仓位回合, 记录仓位的开平仓价格, 仓位数量等详细信息
- `ItemId` 标的标识符, 包含了标的 symbol 和标的类型 (现货合约等)
- `Money` 金额类, 包括金额数值和货币类型
- `Quantity` 仓位数量类, 包含了仓位数量和仓位数量单位, 以及带非负校验的构造方法
- `TradeRowVO` 仓位回合读模型

## exchange_project_trade（项目开平仓回合明细表）

**表备注**：项目交易/持仓明细（事实表），驱动影子/实盘、收益复算与报表
**分区策略**：按 `ts_open` 做 RANGE 分区（已建：`p2025_08`、`p2025_09`、`p2025_10`、`pMAX`）

### 字段

| 列名                  | 数据类型                                                | 约束                                                                                                | 字段注解                                 |
|---------------------|-----------------------------------------------------|---------------------------------------------------------------------------------------------------|--------------------------------------|
| id                  | BIGINT                                              | NOT NULL, AUTO_INCREMENT, PK                                                                      | 主键ID                                 |
| project_id          | BIGINT                                              | NOT NULL                                                                                          | 逻辑外键，指向 `exchange_project.id`        |
| trade_uid           | CHAR(64)                                            | NULL                                                                                              | 系统内回合唯一ID；无外部ID时的合成ID（SHA-256）       |
| symbol              | VARCHAR(64)                                         | NOT NULL                                                                                          | 交易标的（如 `BTC-USDT` / `BTC-USDT-SWAP`） |
| inst_type           | ENUM('SPOT','SWAP','FUTURES','MARGIN')              | NULL                                                                                              | 产品类型（可空）                             |
| side                | ENUM('LONG','SHORT','BUY','SELL')                   | NOT NULL                                                                                          | 方向：合约 `LONG/SHORT`，现货 `BUY/SELL`     |
| ord_type            | ENUM('MARKET','LIMIT','POST_ONLY','FOK','IOC')      | NULL                                                                                              | 订单类型（可空）                             |
| leverage            | DECIMAL(18,8)                                       | NULL                                                                                              | 杠杆（若适用）                              |
| ts_open             | TIMESTAMP(3)                                        | NOT NULL                                                                                          | 开仓/触发时间（分区键）                         |
| ts_filled           | TIMESTAMP(3)                                        | NULL                                                                                              | 完全成交时间                               |
| ts_close            | TIMESTAMP(3)                                        | NULL                                                                                              | 平仓时间                                 |
| entry_price         | DECIMAL(36,18)                                      | NULL                                                                                              | 入场价格                                 |
| exit_price          | DECIMAL(36,18)                                      | NULL                                                                                              | 出场价格                                 |
| qty                 | DECIMAL(36,18)                                      | NOT NULL                                                                                          | 仓位（恒正）                               |
| fees                | DECIMAL(36,18)                                      | NULL                                                                                              | 手续费等成本（可为负）                          |
| fee_ccy             | VARCHAR(16)                                         | NULL, DEFAULT 'USDT'                                                                              | 手续费币种                                |
| pnl                 | DECIMAL(36,18)                                      | NULL                                                                                              | 实现盈亏（可为负）                            |
| pnl_ccy             | VARCHAR(16)                                         | NULL, DEFAULT 'USDT'                                                                              | PnL 计价币                              |
| status              | ENUM('OPEN','PARTIALLY_CLOSED','CLOSED','CANCELED') | NOT NULL, DEFAULT 'CLOSED'                                                                        | 成交/持仓状态                              |
| source              | VARCHAR(32)                                         | NOT NULL, DEFAULT 'OKX'                                                                           | 来源：OKX/BINANCE/REPLAY/IMPORT 等       |
| external_trade_id   | VARCHAR(191)                                        | NULL                                                                                              | 交易所侧成交ID（优先幂等键）                      |
| external_order_id   | VARCHAR(191)                                        | NULL                                                                                              | 交易所侧订单ID（一般锚定最早开仓单）                  |
| source_payload_hash | CHAR(64)                                            | NOT NULL                                                                                          | 来源原文 SHA-256（十六进制），用于幂等/审计           |
| duration_sec        | INT                                                 | GENERATED ALWAYS AS `IF(ts_close IS NULL, NULL, TIMESTAMPDIFF(SECOND, ts_open, ts_close))` STORED | 生成列：持仓时长（秒）                          |

### 索引与作用

| 索引名                     | 类型    | 列                                                             | 唯一性 | 作用说明                                                           |
|-------------------------|-------|---------------------------------------------------------------|-----|----------------------------------------------------------------|
| PRIMARY                 | BTREE | id                                                            | 是   | 主键定位。                                                          |
| uk_trade_uid            | BTREE | (project_id, trade_uid)                                       | 是   | 以内部回合ID实现幂等；适用于无法获得外部成交ID的场景。                                  |
| uk_proj_source_trade_id | BTREE | (project_id, source, external_trade_id)                       | 是   | 以外部成交ID实现强幂等；注意 `external_trade_id` 可空（MySQL 唯一索引允许多个 `NULL`）。 |
| uk_natural_composite    | BTREE | (project_id, symbol, side, ts_open, entry_price, qty, source) | 是   | 自然键兜底幂等（需规范时间精度与价格小数位以避免抖动）。                                   |
| idx_proj_open           | BTREE | (project_id, ts_open)                                         | 否   | 项目维度按开仓时间区间检索/排序；支持分区裁剪。                                       |
| idx_proj_close          | BTREE | (project_id, ts_close)                                        | 否   | 项目维度按平仓时间检索/统计（不参与分区裁剪，但可走索引）。                                 |
| idx_proj_symbol_open    | BTREE | (project_id, symbol, ts_open)                                 | 否   | 同项目同标的的时间序列查询（如复盘/报表）。                                         |
| idx_external_trade_id   | BTREE | external_trade_id                                             | 否   | 直接通过外部成交ID回查。                                                  |

### 备注

* 幂等策略为“外部ID优先、内部UID其次、自然键兜底”，覆盖不同数据完整度来源。
* 由于以 `ts_open` 分区，基于 `ts_close` 的查询无法分区裁剪；若大量按平仓时间检索，可考虑增加基于 `ts_close` 的汇总表或维护二级索引表。
* 涉及价格/数量的大精度字段采用 `DECIMAL(36,18)` 以对齐跨所精度；入库前应统一时间粒度（毫秒/微秒）与小数位规范，减少自然键冲突。

## exchange_project_trade_metrics（项目交易指标派生表）

**表备注**：成交派生指标（MAE/MFE/滑点/回撤等），可多版本重算，与事实表通过 `trade_id` 关联
**Engine**：InnoDB｜**Charset/Collation**：utf8mb4 / utf8mb4_0900_ai_ci
**分区策略**：按 `ts_open` 的 RANGE 分区（`p2025_08`、`p2025_09`、`p2025_10`、`pMAX`）

### 字段

| 列名            | 数据类型           | 约束                           | 字段注解                                         |
|---------------|----------------|------------------------------|----------------------------------------------|
| id            | BIGINT         | NOT NULL, AUTO_INCREMENT, PK | 主键ID                                         |
| trade_id      | BIGINT         | NOT NULL                     | 逻辑外键，指向 `exchange_project_trade.id`          |
| project_id    | BIGINT         | NOT NULL                     | 冗余以便按项目过滤/统计（来自 trade.project_id）            |
| ts_open       | TIMESTAMP(3)   | NOT NULL                     | 冗余以与主表分区对齐（来自 trade.ts_open）                 |
| source        | VARCHAR(32)    | NOT NULL, DEFAULT 'COMPUTED' | 指标来源：COMPUTED/BACKFILL/IMPORT 等              |
| algo_ver      | VARCHAR(16)    | NOT NULL, DEFAULT 'v1'       | 算法/口径版本                                      |
| bar_interval  | VARCHAR(8)     | NULL                         | 行情粒度：1s/1m/5m/15m/1h/1d                      |
| price_source  | VARCHAR(16)    | NULL                         | 价格口径：MID/LAST/BID/ASK                        |
| mae_pct       | DECIMAL(18,6)  | NULL                         | 最大不利变动百分比（多头 min/空头 max，通常为负）                |
| mfe_pct       | DECIMAL(18,6)  | NULL                         | 最大有利变动百分比（多头 max/空头 min，通常为正）                |
| mae_usd       | DECIMAL(36,18) | NULL                         | 最大不利变动金额（USDT，≈ mae_pct * entry_price * qty） |
| mfe_usd       | DECIMAL(36,18) | NULL                         | 最大有利变动金额（USDT，≈ mfe_pct * entry_price * qty） |
| mae_ts        | TIMESTAMP(3)   | NULL                         | 发生 MAE 的时间                                   |
| mfe_ts        | TIMESTAMP(3)   | NULL                         | 发生 MFE 的时间                                   |
| slippage_pct  | DECIMAL(18,6)  | NULL                         | 滑点百分比（成交 vs 预期）                              |
| slippage_usd  | DECIMAL(36,18) | NULL                         | 滑点金额（USDT）                                   |
| max_dd_pct    | DECIMAL(18,6)  | NULL                         | 区间最大回撤百分比                                    |
| max_ru_pct    | DECIMAL(18,6)  | NULL                         | 区间最大回升百分比                                    |
| quality_score | FLOAT          | NULL, DEFAULT 1.0            | 数据质量分（0~1）                                   |
| extra         | JSON           | NOT NULL                     | 计算上下文与参数原文（如 bars 数、异常标记等）                   |

### 索引与作用

| 索引名           | 类型    | 列                     | 唯一性 | 作用说明                                    |
|---------------|-------|-----------------------|-----|-----------------------------------------|
| PRIMARY       | BTREE | id                    | 是   | 主键定位。                                   |
| uk_trade_ver  | BTREE | (trade_id, algo_ver)  | 是   | 同一笔成交在同一算法版本仅保留一份指标；支持幂等 upsert 与版本化重算。 |
| idx_proj_open | BTREE | (project_id, ts_open) | 否   | 项目维度按时间范围检索/聚合；与分区键一致，利于分区裁剪。           |
| idx_mae_pct   | BTREE | mae_pct               | 否   | 基于 MAE 百分比的筛选/排序（如风控分位统计）。              |
| idx_mfe_pct   | BTREE | mfe_pct               | 否   | 基于 MFE 百分比的筛选/排序（如绩效分位统计）。              |

### 备注

* 若需要在同一成交、同一算法版本下按 `price_source` 或 `bar_interval` 并行保存多口径，可将唯一键扩展为
  `(trade_id, algo_ver, price_source, bar_interval)`；当前设计是“每成交每版本一份”。
* 指标金额口径为线性近似（基于 `entry_price * qty`），适合统计排序与分位分析；精确复算请回到事实表结合逐笔或K线重估。

# 5. 实盘跟单 + 风控/路由 (Execution & Risk) ※可选后续

**目标**: 将已验证的影子策略用于实盘账户。
**聚合**

* **`CopyTask`** (聚合根) : `copyTaskId, projectId, status, riskConfig, routeConfig`
  行为: `start/pause/stop/updateConfig`
* **`CopyOrder`** (聚合根) : `clientOrderId, accountId, instId, side, qty, price, status, reason`
  行为: `acknowledge(exchangeOrderId)`, `fill(...)`, `cancel(...)`, `fail(reason)`
* **`RiskProfile`** (聚合或值对象) : `maxPos, maxNotional, maxLeverage, whitelist/blacklist...`
  行为: `allow(orderIntent) → Decision(ALLOW/REJECT/ADJUST)`
  **VO**
* `OrderIntentVO`, `DecisionVO(adjustedQty, reason)`
  **端口**
* `port.ITradingAccountPort` (place/cancel/orderStatus)
* `port.IInstrumentMetaPort` (精度/最小下单量)
* `repository.ICopyTaskRepository`, `ICopyOrderRepository`
  **表映射**: `copy_task`, `copy_order`, `copy_execution_log` (可扩展)