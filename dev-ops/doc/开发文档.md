# 1. 外部抓取 (Crawl 领域) 

- `CrawlTaskAggregate` 爬取任务聚合
  - 在同一时间窗口内, 针对同一交易所, 同一 API, 同一规范化参数, 仅创建并执行一次任务
  - 可以记录任务的完成进度, 以便中断恢复
  - 提供锁与过期 TTL, 避免单次执行时间过长导致的重入
- `CrawlLogEntity` 爬取任务的日志实体, 每一条都是**不可变事实**
  - 用于记录一个爬取任务内的一次爬取操作的 **输入, 结果, 状态, 耗时** 等信息
  - 使用 `success` 和 `failure` 方法进行爬取操作日志的受控创建

---

# 2. 项目目录/主档 (Project 领域) 

- `ProjectAggregate` 项目主档聚合, 记录项目的基本信息, 对系统内的项目进行受控创建
- `ProjectBriefVO` 项目简单快照, 将一些 API 返回的基本信息进行映射, 也用于 **创建新的项目主档**
- `ProjectKey` 系统内项目唯一标识, 由 **交易所名称** 和 **外部 ID** 组成 `(Exchange:ExternalId)`
- `LeadTradersQuery` 获取交易员排名的请求参数结构
- `LeadTradersPageVO` 交易员榜单分页数据响应, 用于把 API 返回数据映射成对象

---

# 3. 项目快照 + 可见性变化事件 (Observation 领域) 

**目标**: 时序画像 + 基于观察的可见性变化记录。
**聚合**

* **`ProjectSnapshot`** (将“每个时间点的快照”当成独立聚合，便于高吞吐写入) : 
  键: `snapshotId = projectId + snapshotTs`
  字段: `projectId, snapshotTs, roi1d/7d/30d, pnl*, aum, winRate, tradesCount, maxDrawdown, sharpe, followers ...`
  行为: **纯快照** (无跨快照不变式，避免聚合过大) 
* **`Tombstone`** (聚合根) : 
  键: `tombstoneId`
  字段: `projectId, fromTs, toTs?, reasonCode, reasonMsg, detector`
  行为: `close(toTs)` (结束墓碑区间) 
  **VO**
* `SnapshotPointVO`: 用于曲线渲染
* `VisibilityChangeVO`: `from(VISIBLE)->to(MISSING/HIDDEN), atTs, reason`
  **端口**
* `repository.IProjectSnapshotRepository`: `appendIfAbsent`, `listRange(projectId, from, to)`
* `repository.ITombstoneRepository`: `openIfAbsent`, `closeOpenIntervals(...)`
  **表映射**: `exchange_project_snapshot` (月分区) ，`tombstone`

---

# 4. 仓位回合 (Trade 领域) 

**目标**: 事实表，驱动影子/实盘、收益复算与报表。
**聚合**

* **`ProjectTrade`** (每一笔成交作为聚合根，或以组合键模拟) : 
  键: `tradeId` (优先交易所原始 id；若无: `hash(projectId, instId, side, createTs, qty, price)`) 
  字段: `projectId, instId, side, ordType, leverage, qty, price, fee, pnl, createTs, filledTs?, closeTs?, status, sourcePayloadHash`
  不变式: `qty>0, price>0`
  **值对象**
* `InstrumentId`，`Money(BigDecimal, ccy)`，`Quantity`
  **VO**
* `TradeRowVO`: 表格/导出视图
  **端口**
* `repository.IProjectTradeRepository`: `appendIfAbsent`, `listRange`, `listBySymbol(...)`
  **表映射**: `exchange_project_trade` (月分区) 

---

# 5. 查询与报表 (ReadModel) 

**目标**: 为 API 输出**专用视图**，不污染领域对象。
**VO (只读视图对象) **

* `ProjectPageItemVO`: `projectId, name, visibility, followers, aum, roi30d`
* `ProjectDetailViewVO`: 主档 + 最新快照 + 最近 N 笔成交
* `TombstoneViewVO`、`TradeExportRowVO`、`ShadowPerformanceVO`
  **端口**
* `repository.IProjectReadModelRepository` (可以用聚合查询/物化视图) 
* **提示**: ReadModel 可以落在 `infrastructure` 做专用 SQL，`domain` 定义只读接口与 VO。

---

# 6. 实盘跟单 + 风控/路由 (Execution & Risk) ※可选后续

**目标**: 将已验证的影子策略用于实盘账户。
**聚合**

* **`CopyTask`** (聚合根) : `copyTaskId, projectId, status, riskConfig, routeConfig`
  行为: `start/pause/stop/updateConfig`
* **`CopyOrder`** (聚合根) : `clientOrderId, accountId, instId, side, qty, price, status, reason`
  行为: `acknowledge(exchangeOrderId)`, `fill(...)`, `cancel(...)`, `fail(reason)`
* **`RiskProfile`** (聚合或值对象) : `maxPos, maxNotional, maxLeverage, whitelist/blacklist...`
  行为: `allow(orderIntent) → Decision(ALLOW/REJECT/ADJUST)`
  **VO**
* `OrderIntentVO`, `DecisionVO(adjustedQty, reason)`
  **端口**
* `port.ITradingAccountPort` (place/cancel/orderStatus) 
* `port.IInstrumentMetaPort` (精度/最小下单量) 
* `repository.ICopyTaskRepository`, `ICopyOrderRepository`
  **表映射**: `copy_task`, `copy_order`, `copy_execution_log` (可扩展)